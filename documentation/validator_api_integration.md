# Islamic Finance Compliance API Integration

This document explains how the Islamic Finance Compliance API has been integrated into the validator agent workflow to provide additional Shariah compliance verification.

## Overview

The validator agent now has an additional layer of validation that uses an external API specializing in Islamic finance compliance. This API has access to specialized knowledge sources including the Quran and Sunnah, allowing for deeper Shariah compliance verification.

## How It Works

1. The validator agent first performs its standard validation using its LLM-based approach
2. If enabled, it then sends the proposal to the Islamic Finance Compliance API for additional verification
3. The results from both validation methods are combined into a unified output format
4. If the API validation contradicts an "APPROVED" decision from the LLM, the final status will be changed to "NEEDS REVISION"

## Configuration Options

The ValidatorAgent class accepts the following parameters:

```python
ValidatorAgent(
    use_compliance_api: bool = True,  # Whether to use the external API
    compliance_api_url: Optional[str] = None  # Custom API URL (optional)
)
```

You can also configure the API URL via the `ISLAMIC_FINANCE_API_URL` environment variable, which takes precedence over the constructor parameter.

## Output Format

The validation output follows the same format as before, ensuring compatibility with the existing output parser and UI. The validation result is a Markdown-formatted string with the following sections:

```markdown
# Validation Results

## Primary Validation Assessment
[Original LLM validation content]

## Additional Shariah Compliance Insights
The following insights were provided by specialized Islamic Finance Compliance resources with access to Quran and Sunnah references:

[API validation content]

## Final Decision
[Combined decision with reasoning]
```

## Error Handling

If the API call fails for any reason:
- The error is logged to the console
- The system gracefully falls back to using only the primary LLM validation
- The user experience remains uninterrupted

## Testing

A test script (`test_validator_api.py`) is provided to verify the functionality of the API integration:

```bash
python test_validator_api.py
```

This will generate two output files:
- `validation_with_api.json`: Results using both validation methods
- `validation_without_api.json`: Results using only the primary LLM validation

## API Documentation

The Islamic Finance Compliance API is a RESTful service that answers questions about Shariah compliance using RAG (Retrieval-Augmented Generation) powered by Gemini and Neo4j.

### Endpoint

- **URL**: http://10.80.12.74:8000/api/ask
- **Method**: POST

### Request Parameters

| Field       | Type   | Required | Default | Description                                       |
|-------------|--------|----------|---------|---------------------------------------------------|
| question    | string | Yes      | —       | The question about Shariah compliance             |
| top_k       | int    | No       | 6       | Number of top documents to retrieve from Neo4j    |
| temperature | float  | No       | 0.1     | Controls the creativity of the LLM response (0–1) |

### Response Format

| Field          | Type   | Description                             |
|----------------|--------|-----------------------------------------|
| answer         | string | The answer generated by the LLM         |
| processing_time| float  | Total time in seconds to process query  |
``` 